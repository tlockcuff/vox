name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          echo "SHORT_VERSION=$(echo ${GITHUB_REF#refs/tags/v} | sed 's/^v//')" >> $GITHUB_OUTPUT

      - name: Build Vox
        run: |
          cd VoxApp
          swift build -c release
          cd ..

      - name: Download sherpa-onnx
        run: |
          SHERPA_VERSION="v1.12.25"
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/${SHERPA_VERSION}/sherpa-onnx-${SHERPA_VERSION}-osx-universal2-shared.tar.bz2" -o sherpa.tar.bz2
          tar xf sherpa.tar.bz2
          SHERPA_DIR=$(ls -d sherpa-onnx-*)
          mkdir -p staging/bin staging/lib
          cp "${SHERPA_DIR}/bin/sherpa-onnx-offline-tts" staging/bin/
          cp ${SHERPA_DIR}/lib/*.dylib staging/lib/
          rm -rf sherpa.tar.bz2 "${SHERPA_DIR}"

      - name: Download Kokoro model
        run: |
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/kokoro-en-v0_19.tar.bz2" -o kokoro.tar.bz2
          tar xf kokoro.tar.bz2
          mv kokoro-en-v0_19 staging/
          rm kokoro.tar.bz2

      - name: Create .app bundle
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          SHORT_VERSION="${VERSION#v}"

          APP="Vox.app"
          CONTENTS="${APP}/Contents"
          MACOS="${CONTENTS}/MacOS"
          FRAMEWORKS="${CONTENTS}/Frameworks"
          RESOURCES="${CONTENTS}/Resources"

          mkdir -p "${MACOS}" "${FRAMEWORKS}" "${RESOURCES}"

          # Main executable
          cp VoxApp/.build/release/Vox "${MACOS}/Vox"

          # TTS engine + dylibs in Frameworks
          cp staging/bin/sherpa-onnx-offline-tts "${FRAMEWORKS}/"
          cp staging/lib/*.dylib "${FRAMEWORKS}/"

          # Model in Resources
          cp -r staging/kokoro-en-v0_19 "${RESOURCES}/"

          # Fix dylib paths
          cd "${FRAMEWORKS}"
          for dylib in *.dylib; do
            install_name_tool -id "@loader_path/${dylib}" "${dylib}" 2>/dev/null || true
          done
          for dylib in *.dylib; do
            install_name_tool -change "@rpath/${dylib}" "@loader_path/${dylib}" sherpa-onnx-offline-tts 2>/dev/null || true
          done
          cd -

          # Info.plist
          cat > "${CONTENTS}/Info.plist" << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>Vox</string>
              <key>CFBundleDisplayName</key>
              <string>Vox</string>
              <key>CFBundleIdentifier</key>
              <string>com.tlockcuff.vox</string>
              <key>CFBundleVersion</key>
              <string>${SHORT_VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${SHORT_VERSION}</string>
              <key>CFBundleExecutable</key>
              <string>Vox</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLIST

          # Codesign everything
          codesign --force --deep --sign - "${FRAMEWORKS}/"*.dylib
          codesign --force --deep --sign - "${FRAMEWORKS}/sherpa-onnx-offline-tts"
          codesign --force --deep --sign - "${MACOS}/Vox"
          codesign --force --deep --sign - "${APP}"

          chmod +x "${MACOS}/Vox" "${FRAMEWORKS}/sherpa-onnx-offline-tts"

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_NAME="Vox-${VERSION}.dmg"

          mkdir -p dmg-staging
          cp -r Vox.app dmg-staging/
          ln -s /Applications dmg-staging/Applications

          hdiutil create -volname "Vox" -srcfolder dmg-staging -ov -format UDZO "${DMG_NAME}"
          rm -rf dmg-staging

      - name: Also create zip (for update.sh)
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          # Create a zip of the .app for programmatic updates
          mkdir -p Vox-macOS
          cp -r Vox.app Vox-macOS/
          cp scripts/vox.sh Vox-macOS/
          cp scripts/install.sh Vox-macOS/
          sed -i '' "s/v0.5.0/${VERSION}/g" Vox-macOS/install.sh
          cp README.md Vox-macOS/
          # Also include bin/ and model for install.sh compatibility
          mkdir -p Vox-macOS/bin
          cp Vox.app/Contents/Frameworks/* Vox-macOS/bin/
          cp Vox.app/Contents/MacOS/Vox Vox-macOS/Vox
          chmod +x Vox-macOS/install.sh Vox-macOS/vox.sh Vox-macOS/Vox
          zip -r "Vox-macOS-${VERSION}.zip" Vox-macOS/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Vox ${{ steps.version.outputs.VERSION }}
          body: |
            ## Vox ${{ steps.version.outputs.VERSION }}

            **Highlight ‚Üí Right-Click ‚Üí Speak** with natural AI voices on macOS.

            ### Installation

            **Option 1: DMG (Recommended)**
            1. Download `Vox-${{ steps.version.outputs.VERSION }}.dmg`
            2. Open the DMG
            3. Drag **Vox** to **Applications**
            4. Launch Vox from Applications
            5. First launch installs the right-click Quick Action automatically

            **Option 2: CLI**
            ```bash
            ~/.vox/update.sh
            ```

            ### Features
            - üó£Ô∏è Natural AI voices (Kokoro TTS, 11 speakers)
            - üéµ Animated waveform visualizer
            - ‚è±Ô∏è ETA countdown
            - ‚èØÔ∏è Play/pause/stop controls in menu bar
            - üéöÔ∏è Speed control (0.5x - 2.0x)
            - üßπ Smart text cleanup (strips URLs, markdown, HTML)
            - üîÑ Built-in update checker
          files: |
            Vox-${{ steps.version.outputs.VERSION }}.dmg
            Vox-macOS-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
