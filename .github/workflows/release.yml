name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
            echo "SHORT_VERSION=$(echo ${{ github.event.inputs.tag }} | sed 's/^v//')" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
            echo "SHORT_VERSION=$(echo ${GITHUB_REF#refs/tags/} | sed 's/^v//')" >> $GITHUB_OUTPUT
          fi

      - name: Import signing certificate
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -hex 16)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH=$RUNNER_TEMP/cert.p12
          echo "$DEVELOPER_ID_CERT_BASE64" | base64 --decode > "$CERT_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$DEVELOPER_ID_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productsign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Add to search list
          security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')

          # Find signing identity
          IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID Application" | head -1 | awk -F'"' '{print $2}')
          if [[ -z "$IDENTITY" ]]; then
            echo "‚ùå No Developer ID Application identity found"
            security find-identity -v -p codesigning "$KEYCHAIN_PATH"
            exit 1
          fi
          echo "SIGNING_IDENTITY=$IDENTITY" >> $GITHUB_ENV
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
          echo "‚úÖ Signing identity: $IDENTITY"

      - name: Generate app icon
        run: bash scripts/generate-icon.sh VoxApp/Sources/Assets.xcassets/AppIcon.appiconset

      - name: Build Vox
        run: |
          cd VoxApp
          swift build -c release
          cd ..

      - name: Download sherpa-onnx
        run: |
          SHERPA_VERSION="v1.12.25"
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/${SHERPA_VERSION}/sherpa-onnx-${SHERPA_VERSION}-osx-universal2-shared.tar.bz2" -o sherpa.tar.bz2
          tar xf sherpa.tar.bz2
          SHERPA_DIR=$(ls -d sherpa-onnx-*)
          mkdir -p staging/bin staging/lib
          cp "${SHERPA_DIR}/bin/sherpa-onnx-offline-tts" staging/bin/
          cp ${SHERPA_DIR}/lib/*.dylib staging/lib/
          rm -rf sherpa.tar.bz2 "${SHERPA_DIR}"

      - name: Download Kokoro model
        run: |
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/kokoro-en-v0_19.tar.bz2" -o kokoro.tar.bz2
          tar xf kokoro.tar.bz2
          mv kokoro-en-v0_19 staging/
          rm kokoro.tar.bz2

      - name: Create .app bundle
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          SHORT_VERSION="${{ steps.version.outputs.SHORT_VERSION }}"

          APP="Vox.app"
          CONTENTS="${APP}/Contents"
          MACOS="${CONTENTS}/MacOS"
          FRAMEWORKS="${CONTENTS}/Frameworks"
          RESOURCES="${CONTENTS}/Resources"

          mkdir -p "${MACOS}" "${FRAMEWORKS}" "${RESOURCES}"

          # Main executable
          cp VoxApp/.build/release/Vox "${MACOS}/Vox"

          # TTS engine + dylibs in Frameworks
          cp staging/bin/sherpa-onnx-offline-tts "${FRAMEWORKS}/"
          cp staging/lib/*.dylib "${FRAMEWORKS}/"

          # Model in Resources
          cp -r staging/kokoro-en-v0_19 "${RESOURCES}/"

          # App icon
          ICONSET="${RESOURCES}/AppIcon.iconset"
          mkdir -p "${ICONSET}"
          ICON_SRC="VoxApp/Sources/Assets.xcassets/AppIcon.appiconset"
          cp "${ICON_SRC}/icon_16.png" "${ICONSET}/icon_16x16.png"
          cp "${ICON_SRC}/icon_32.png" "${ICONSET}/icon_16x16@2x.png"
          cp "${ICON_SRC}/icon_32.png" "${ICONSET}/icon_32x32.png"
          cp "${ICON_SRC}/icon_64.png" "${ICONSET}/icon_32x32@2x.png"
          cp "${ICON_SRC}/icon_128.png" "${ICONSET}/icon_128x128.png"
          cp "${ICON_SRC}/icon_256.png" "${ICONSET}/icon_128x128@2x.png"
          cp "${ICON_SRC}/icon_256.png" "${ICONSET}/icon_256x256.png"
          cp "${ICON_SRC}/icon_512.png" "${ICONSET}/icon_256x256@2x.png"
          cp "${ICON_SRC}/icon_512.png" "${ICONSET}/icon_512x512.png"
          cp "${ICON_SRC}/icon_1024.png" "${ICONSET}/icon_512x512@2x.png"
          iconutil -c icns "${ICONSET}" -o "${RESOURCES}/AppIcon.icns"
          rm -rf "${ICONSET}"

          # Fix dylib rpaths so DYLD_LIBRARY_PATH isn't needed
          cd "${FRAMEWORKS}"
          for dylib in *.dylib; do
            install_name_tool -id "@loader_path/${dylib}" "${dylib}" 2>/dev/null || true
          done
          # Fix all cross-references between dylibs
          for binary in sherpa-onnx-offline-tts *.dylib; do
            for dylib in *.dylib; do
              install_name_tool -change "@rpath/${dylib}" "@loader_path/${dylib}" "${binary}" 2>/dev/null || true
              install_name_tool -change "/usr/local/lib/${dylib}" "@loader_path/${dylib}" "${binary}" 2>/dev/null || true
              install_name_tool -change "${dylib}" "@loader_path/${dylib}" "${binary}" 2>/dev/null || true
            done
          done
          cd -

          # Info.plist
          cat > "${CONTENTS}/Info.plist" <<'          PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>Vox</string>
              <key>CFBundleDisplayName</key>
              <string>Vox</string>
              <key>CFBundleIdentifier</key>
              <string>com.tlockcuff.vox</string>
              <key>CFBundleExecutable</key>
              <string>Vox</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <true/>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          PLIST
          sed -i '' "s|</dict>|    <key>CFBundleVersion</key><string>${SHORT_VERSION}</string><key>CFBundleShortVersionString</key><string>${SHORT_VERSION}</string></dict>|" "${CONTENTS}/Info.plist"

          chmod +x "${MACOS}/Vox" "${FRAMEWORKS}/sherpa-onnx-offline-tts"

      - name: Codesign .app bundle
        run: |
          APP="Vox.app"
          FRAMEWORKS="${APP}/Contents/Frameworks"
          ENTITLEMENTS="scripts/entitlements.plist"

          # Sign dylibs first (inside out) ‚Äî with entitlements for ONNX Runtime JIT
          for dylib in "${FRAMEWORKS}"/*.dylib; do
            codesign --force --options runtime --timestamp \
              --entitlements "$ENTITLEMENTS" \
              --sign "$SIGNING_IDENTITY" "$dylib"
          done

          # Sign TTS binary with entitlements
          codesign --force --options runtime --timestamp \
            --entitlements "$ENTITLEMENTS" \
            --sign "$SIGNING_IDENTITY" "${FRAMEWORKS}/sherpa-onnx-offline-tts"

          # Sign main executable with entitlements
          codesign --force --options runtime --timestamp \
            --entitlements "$ENTITLEMENTS" \
            --sign "$SIGNING_IDENTITY" "${APP}/Contents/MacOS/Vox"

          # Sign the whole .app bundle
          codesign --force --deep --options runtime --timestamp \
            --entitlements "$ENTITLEMENTS" \
            --sign "$SIGNING_IDENTITY" "$APP"

          # Verify
          codesign --verify --deep --strict --verbose=2 "$APP"
          echo "‚úÖ Codesigning verified"

      - name: Notarize .app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create a zip for notarization
          ditto -c -k --keepParent Vox.app Vox-notarize.zip
          echo "üì§ Zip size: $(du -sh Vox-notarize.zip | cut -f1)"

          # Submit for notarization
          echo "üì§ Submitting for notarization..."
          SUBMIT_OUTPUT=$(xcrun notarytool submit Vox-notarize.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --output-format json 2>&1) || true
          echo "$SUBMIT_OUTPUT"

          SUBMISSION_ID=$(echo "$SUBMIT_OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('id',''))" 2>/dev/null || echo "")
          if [[ -z "$SUBMISSION_ID" ]]; then
            echo "‚ùå Failed to get submission ID"
            echo "$SUBMIT_OUTPUT"
            exit 1
          fi
          echo "üìã Submission ID: $SUBMISSION_ID"

          # Poll for completion
          echo "‚è≥ Waiting for Apple to process..."
          for i in $(seq 1 60); do
            sleep 30
            STATUS_OUTPUT=$(xcrun notarytool info "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --output-format json 2>&1) || true

            STATUS=$(echo "$STATUS_OUTPUT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('status','Unknown'))" 2>/dev/null || echo "Unknown")
            echo "  [$((i * 30))s] Status: $STATUS"

            if [[ "$STATUS" == "Accepted" ]]; then
              echo "‚úÖ Notarization accepted!"
              break
            elif [[ "$STATUS" == "Invalid" || "$STATUS" == "Rejected" ]]; then
              echo "‚ùå Notarization failed: $STATUS"
              xcrun notarytool log "$SUBMISSION_ID" \
                --apple-id "$APPLE_ID" \
                --password "$APPLE_APP_SPECIFIC_PASSWORD" \
                --team-id "$APPLE_TEAM_ID" 2>&1 || true
              exit 1
            fi
          done

          if [[ "$STATUS" != "Accepted" ]]; then
            echo "‚ùå Notarization timed out after 30 minutes"
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" 2>&1 || true
            exit 1
          fi

          # Staple the ticket to the app
          echo "üìé Stapling notarization ticket..."
          xcrun stapler staple Vox.app

          echo "‚úÖ Notarization complete"
          rm Vox-notarize.zip

      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DMG_NAME="Vox-${VERSION}.dmg"

          mkdir -p dmg-staging
          cp -r Vox.app dmg-staging/
          ln -s /Applications dmg-staging/Applications

          hdiutil create -volname "Vox" -srcfolder dmg-staging -ov -format UDZO "${DMG_NAME}"
          rm -rf dmg-staging

          # Sign the DMG
          codesign --force --timestamp --sign "$SIGNING_IDENTITY" "${DMG_NAME}"

          # Notarize DMG (the .app inside is already notarized, so this is fast)
          echo "üì§ Notarizing DMG..."
          xcrun notarytool submit "${DMG_NAME}" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --password "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --wait --timeout 1800 || echo "‚ö†Ô∏è DMG notarization timed out (app is still notarized)"
          xcrun stapler staple "${DMG_NAME}" || echo "‚ö†Ô∏è DMG staple skipped"
          echo "‚úÖ DMG done"

      - name: Also create zip (for update.sh)
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          mkdir -p Vox-macOS
          cp -r Vox.app Vox-macOS/
          cp scripts/vox.sh Vox-macOS/
          cp scripts/install.sh Vox-macOS/
          sed -i '' "s/v0.5.0/${VERSION}/g" Vox-macOS/install.sh
          cp README.md Vox-macOS/
          mkdir -p Vox-macOS/bin
          cp Vox.app/Contents/Frameworks/* Vox-macOS/bin/
          cp Vox.app/Contents/MacOS/Vox Vox-macOS/Vox
          cp -r Vox.app/Contents/Resources/kokoro-en-v0_19 Vox-macOS/
          chmod +x Vox-macOS/install.sh Vox-macOS/vox.sh Vox-macOS/Vox
          zip -r "Vox-macOS-${VERSION}.zip" Vox-macOS/

      - name: Cleanup keychain
        if: always()
        run: |
          if [[ -n "${KEYCHAIN_PATH:-}" ]]; then
            security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: Vox ${{ steps.version.outputs.VERSION }}
          body: |
            ## Vox ${{ steps.version.outputs.VERSION }}

            **Highlight ‚Üí Right-Click ‚Üí Speak** with natural AI voices on macOS.

            ### Installation
            1. Download `Vox-${{ steps.version.outputs.VERSION }}.dmg`
            2. Open the DMG
            3. Drag **Vox** to **Applications**
            4. Launch Vox ‚Äî that's it! ‚ú®

            ### Features
            - üó£Ô∏è Natural AI voices (Kokoro TTS, 11 speakers)
            - üéµ Animated waveform visualizer
            - ‚è±Ô∏è ETA countdown
            - ‚èØÔ∏è Play/pause/stop controls in menu bar
            - üéöÔ∏è Speed control (0.5x - 2.0x)
            - üßπ Smart text cleanup (strips URLs, markdown, HTML)
            - üîÑ Built-in update checker
            - ‚úÖ Signed & notarized ‚Äî no Gatekeeper warnings
          files: |
            Vox-${{ steps.version.outputs.VERSION }}.dmg
            Vox-macOS-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
