name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: true
        default: 'v0.1.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download sherpa-onnx
        run: |
          SHERPA_VERSION="v1.12.25"
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/${SHERPA_VERSION}/sherpa-onnx-${SHERPA_VERSION}-osx-universal2-shared.tar.bz2" -o sherpa.tar.bz2
          tar xf sherpa.tar.bz2
          SHERPA_DIR=$(ls -d sherpa-onnx-*)
          mkdir -p build/bin
          cp "${SHERPA_DIR}/bin/sherpa-onnx-offline-tts" build/bin/
          cp ${SHERPA_DIR}/lib/*.dylib build/bin/ 2>/dev/null || true
          chmod +x build/bin/sherpa-onnx-offline-tts
          rm -rf sherpa.tar.bz2 "${SHERPA_DIR}"

      - name: Download Kokoro model
        run: |
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/kokoro-en-v0_19.tar.bz2" -o kokoro.tar.bz2
          tar xf kokoro.tar.bz2
          mv kokoro-en-v0_19 build/
          rm kokoro.tar.bz2

      - name: Download install script
        run: |
          cp scripts/speaksel.sh build/

      - name: Fix dylib paths
        run: |
          cd build/bin
          # Update dylib search paths to be relative
          for dylib in *.dylib; do
            install_name_tool -id "@loader_path/${dylib}" "${dylib}" 2>/dev/null || true
          done
          # Update the binary to look for dylibs in its own directory
          for dylib in *.dylib; do
            install_name_tool -change "@rpath/${dylib}" "@executable_path/${dylib}" sherpa-onnx-offline-tts 2>/dev/null || true
          done

      - name: Package release
        run: |
          mkdir -p SpeakSel-macOS
          cp -r build/bin SpeakSel-macOS/
          cp -r build/kokoro-en-v0_19 SpeakSel-macOS/
          cp scripts/speaksel.sh SpeakSel-macOS/
          cp scripts/install.sh SpeakSel-macOS/
          cp README.md SpeakSel-macOS/
          chmod +x SpeakSel-macOS/install.sh SpeakSel-macOS/speaksel.sh
          zip -r "SpeakSel-macOS-${{ steps.version.outputs.VERSION }}.zip" SpeakSel-macOS/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: SpeakSel ${{ steps.version.outputs.VERSION }}
          body: |
            ## SpeakSel ${{ steps.version.outputs.VERSION }}

            **Highlight → Right-Click → Speak** with natural AI voices on macOS.

            ### Installation
            1. Download `SpeakSel-macOS-${{ steps.version.outputs.VERSION }}.zip`
            2. Unzip and run `./install.sh`
            3. Highlight text anywhere → Right-click → Services → **Speak with SpeakSel**

            ### What's included
            - sherpa-onnx TTS engine (universal binary — Apple Silicon + Intel)
            - Kokoro English v0.19 model (11 natural voices)
            - macOS Quick Action (right-click integration)

            ### Voices
            Default: `am_adam` (American Male). Change with `echo "0" > ~/.speaksel/voice` (see README for all voices).
          files: |
            SpeakSel-macOS-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
