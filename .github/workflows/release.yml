name: Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g. v1.0.0)'
        required: true
        default: 'v0.2.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Build SpeakSel menu bar app
        run: |
          cd SpeakSelApp
          swift build -c release
          cp .build/release/SpeakSel ../SpeakSel-binary
          cd ..

      - name: Download sherpa-onnx
        run: |
          SHERPA_VERSION="v1.12.25"
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/${SHERPA_VERSION}/sherpa-onnx-${SHERPA_VERSION}-osx-universal2-shared.tar.bz2" -o sherpa.tar.bz2
          tar xf sherpa.tar.bz2
          SHERPA_DIR=$(ls -d sherpa-onnx-*)
          mkdir -p build/bin
          cp "${SHERPA_DIR}/bin/sherpa-onnx-offline-tts" build/bin/
          cp ${SHERPA_DIR}/lib/*.dylib build/bin/ 2>/dev/null || true
          chmod +x build/bin/sherpa-onnx-offline-tts
          rm -rf sherpa.tar.bz2 "${SHERPA_DIR}"

      - name: Download Kokoro model
        run: |
          curl -sL "https://github.com/k2-fsa/sherpa-onnx/releases/download/tts-models/kokoro-en-v0_19.tar.bz2" -o kokoro.tar.bz2
          tar xf kokoro.tar.bz2
          mv kokoro-en-v0_19 build/
          rm kokoro.tar.bz2

      - name: Fix dylib paths
        run: |
          cd build/bin
          for dylib in *.dylib; do
            install_name_tool -id "@loader_path/${dylib}" "${dylib}" 2>/dev/null || true
          done
          for dylib in *.dylib; do
            install_name_tool -change "@rpath/${dylib}" "@executable_path/${dylib}" sherpa-onnx-offline-tts 2>/dev/null || true
          done

      - name: Stamp version
        run: |
          sed -i '' "s/v0.5.0/${{ steps.version.outputs.VERSION }}/g" scripts/install.sh

      - name: Package release
        run: |
          mkdir -p SpeakSel-macOS
          cp -r build/bin SpeakSel-macOS/
          cp -r build/kokoro-en-v0_19 SpeakSel-macOS/
          cp scripts/speaksel.sh SpeakSel-macOS/
          cp scripts/install.sh SpeakSel-macOS/
          cp SpeakSel-binary SpeakSel-macOS/SpeakSel
          cp README.md SpeakSel-macOS/
          chmod +x SpeakSel-macOS/install.sh SpeakSel-macOS/speaksel.sh SpeakSel-macOS/SpeakSel
          zip -r "SpeakSel-macOS-${{ steps.version.outputs.VERSION }}.zip" SpeakSel-macOS/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: SpeakSel ${{ steps.version.outputs.VERSION }}
          body: |
            ## SpeakSel ${{ steps.version.outputs.VERSION }}

            **Highlight ‚Üí Right-Click ‚Üí Speak** with natural AI voices on macOS.

            ### What's new
            - üñ•Ô∏è **Menu bar app** ‚Äî visual playback controls (play/pause/stop)
            - ‚ö° **Streaming playback** ‚Äî audio starts playing sentence-by-sentence instead of waiting for full generation
            - üéöÔ∏è **Speed & voice controls** ‚Äî adjust from the menu bar
            - üîß Raycast extension for keyboard shortcut integration

            ### Installation
            1. Download `SpeakSel-macOS-${{ steps.version.outputs.VERSION }}.zip`
            2. Unzip and run `./install.sh`
            3. Launch SpeakSel from the install directory (adds to menu bar)
            4. Highlight text anywhere ‚Üí Right-click ‚Üí Services ‚Üí **Speak with SpeakSel**
          files: |
            SpeakSel-macOS-${{ steps.version.outputs.VERSION }}.zip
          draft: false
          prerelease: false
